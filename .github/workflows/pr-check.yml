name: PR Checks

on:
  pull_request:
    branches: [main]
    paths:
      - 'lua/**'
      - 'tests/**'
      - 'Makefile'
      - '.luarc.json'
      - 'stylua.toml'
      - '.github/workflows/pr-check.yml'
  push:
    branches: [main]
    paths:
      - 'lua/**'
      - 'tests/**'
      - 'Makefile'
      - '.luarc.json'
      - 'stylua.toml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  LUALS_VERSION: 3.16.2
  STYLUA_VERSION: 2.3.1

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup directories
        run: mkdir -p .local/bin

      - name: Cache StyLua
        id: cache-stylua
        uses: actions/cache@v4
        with:
          path: .local/bin/stylua
          key: stylua-${{ runner.os }}-${{ env.STYLUA_VERSION }}

      - name: Install StyLua
        if: steps.cache-stylua.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://github.com/JohnnyMorganz/StyLua/releases/download/v${{ env.STYLUA_VERSION }}/stylua-linux-x86_64.zip" -o stylua.zip
          unzip -q stylua.zip -d .local/bin/
          chmod +x .local/bin/stylua

      - name: Check formatting
        run: |
          export PATH="$PWD/.local/bin:$PATH"
          make format-check

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Luacheck
        run: |
          sudo apt-get update
          sudo apt-get install -y lua-check

      - name: Run luacheck
        run: make luacheck

  test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        neovim-version: ['v0.11.5', 'nightly']

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          # libreadline-dev: Required by hererocks to build Lua 5.1 for busted tests
          # Can be removed if tests no longer use hererocks or switch to pre-built Lua
          sudo apt-get update && sudo apt-get install -y libreadline-dev

      - name: Setup directories
        run: mkdir -p .local/nvim .local/bin

      - name: Cache Neovim
        id: cache-neovim
        uses: actions/cache@v4
        with:
          path: .local/nvim
          key: neovim-${{ runner.os }}-${{ matrix.neovim-version }}

      - name: Install Neovim
        if: steps.cache-neovim.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://github.com/neovim/neovim/releases/download/${{ matrix.neovim-version }}/nvim-linux-x86_64.tar.gz" |
            tar xzf - --strip-components=1 -C .local/nvim

      - name: Cache lazy_repro
        uses: actions/cache@v4
        with:
          path: lazy_repro
          key: lazy-repro-${{ runner.os }}-${{ hashFiles('tests/busted.lua') }}

      - name: Run tests
        run: |
          ln -sf "$PWD/.local/nvim/bin/nvim" .local/bin/nvim
          export PATH="$PWD/.local/bin:$PATH"
          make test

  typecheck:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        neovim-version: ['v0.11.5', 'nightly']

    steps:
      - uses: actions/checkout@v4

      - name: Setup directories
        run: mkdir -p .local/nvim .local/bin .local/luals

      - name: Cache Neovim
        id: cache-neovim
        uses: actions/cache@v4
        with:
          path: .local/nvim
          key: neovim-${{ runner.os }}-${{ matrix.neovim-version }}

      - name: Install Neovim
        if: steps.cache-neovim.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://github.com/neovim/neovim/releases/download/${{ matrix.neovim-version }}/nvim-linux-x86_64.tar.gz" |
            tar xzf - --strip-components=1 -C .local/nvim

      - name: Cache LuaLS
        id: cache-luals
        uses: actions/cache@v4
        with:
          path: .local/luals
          key: luals-${{ runner.os }}-${{ env.LUALS_VERSION }}

      - name: Install LuaLS
        if: steps.cache-luals.outputs.cache-hit != 'true'
        run: |
          curl -sL "https://github.com/LuaLS/lua-language-server/releases/download/${{ env.LUALS_VERSION }}/lua-language-server-${{ env.LUALS_VERSION }}-linux-x64.tar.gz" |
            tar xzf - -C .local/luals

      - name: Run type check
        run: |
          ln -sf "$PWD/.local/luals/bin/lua-language-server" .local/bin/lua-language-server
          ln -sf "$PWD/.local/nvim/bin/nvim" .local/bin/nvim
          export PATH="$PWD/.local/bin:$PATH"
          make luals
